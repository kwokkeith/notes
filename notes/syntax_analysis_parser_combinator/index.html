
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Notes for SUTD's CDPA 50.054">
      
      
        <meta name="author" content="Kenny Lu">
      
      
      
        <link rel="prev" href="../syntax_analysis/">
      
      
        <link rel="next" href="../ir_pseudo_assembly/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Syntax Analysis Parser Combinator - Compiler Design and Program Analysis 50.054</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CSpline+Sans+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Spline Sans Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#50054-top-down-recursive-parsing-using-parser-combinators" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Compiler Design and Program Analysis 50.054" class="md-header__button md-logo" aria-label="Compiler Design and Program Analysis 50.054" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3a2 2 0 0 1 2-2h9.982a2 2 0 0 1 1.414.586l4.018 4.018A2 2 0 0 1 21 7.018V21a2 2 0 0 1-2 2H4.75a.75.75 0 0 1 0-1.5H19a.5.5 0 0 0 .5-.5V8.5h-4a2 2 0 0 1-2-2v-4H5a.5.5 0 0 0-.5.5v6.25a.75.75 0 0 1-1.5 0Zm12-.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 0-.146-.336l-4.018-4.018A.5.5 0 0 0 15 2.5Z"/><path d="M4.53 12.24a.75.75 0 0 1-.039 1.06l-2.639 2.45 2.64 2.45a.75.75 0 1 1-1.022 1.1l-3.23-3a.75.75 0 0 1 0-1.1l3.23-3a.75.75 0 0 1 1.06.04Zm3.979 1.06a.75.75 0 1 1 1.02-1.1l3.231 3a.75.75 0 0 1 0 1.1l-3.23 3a.75.75 0 1 1-1.021-1.1l2.639-2.45-2.64-2.45Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Compiler Design and Program Analysis 50.054
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Syntax Analysis Parser Combinator
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/50054-cdpa/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    50054-cdpa
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../handout/" class="md-tabs__link">
        
  
    
  
  Handout

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../schedule/" class="md-tabs__link">
        
  
    
  
  Schedule

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../introduction/" class="md-tabs__link">
          
  
    
  
  W1

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../fp_haskell/" class="md-tabs__link">
          
  
    
  
  W2

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../fp_haskell_poly/" class="md-tabs__link">
          
  
    
  
  W3

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../fp_applicative_monad/" class="md-tabs__link">
          
  
    
  
  W4

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../syntax_analysis/" class="md-tabs__link">
          
  
    
  
  W5

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
    
  
  W6

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../semantic_analysis/" class="md-tabs__link">
          
  
    
  
  W8

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../static_semantics/" class="md-tabs__link">
          
  
    
  
  W9

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../name_analysis/" class="md-tabs__link">
          
  
    
  
  W10

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../liveness_analysis/" class="md-tabs__link">
          
  
    
  
  W11

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../advanced_static_analysis/" class="md-tabs__link">
          
  
    
  
  W12

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Compiler Design and Program Analysis 50.054" class="md-nav__button md-logo" aria-label="Compiler Design and Program Analysis 50.054" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3a2 2 0 0 1 2-2h9.982a2 2 0 0 1 1.414.586l4.018 4.018A2 2 0 0 1 21 7.018V21a2 2 0 0 1-2 2H4.75a.75.75 0 0 1 0-1.5H19a.5.5 0 0 0 .5-.5V8.5h-4a2 2 0 0 1-2-2v-4H5a.5.5 0 0 0-.5.5v6.25a.75.75 0 0 1-1.5 0Zm12-.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 0-.146-.336l-4.018-4.018A.5.5 0 0 0 15 2.5Z"/><path d="M4.53 12.24a.75.75 0 0 1-.039 1.06l-2.639 2.45 2.64 2.45a.75.75 0 1 1-1.022 1.1l-3.23-3a.75.75 0 0 1 0-1.1l3.23-3a.75.75 0 0 1 1.06.04Zm3.979 1.06a.75.75 0 1 1 1.02-1.1l3.231 3a.75.75 0 0 1 0 1.1l-3.23 3a.75.75 0 1 1-1.021-1.1l2.639-2.45-2.64-2.45Z"/></svg>

    </a>
    Compiler Design and Program Analysis 50.054
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/50054-cdpa/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    50054-cdpa
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../handout/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Handout
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../schedule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Schedule
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W1
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            W1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fp_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FP Intro
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            W2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fp_haskell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FP Haskell
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W3
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            W3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fp_haskell_poly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FP Haskell Polymorphic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W4
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            W4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fp_applicative_monad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FP Applicative Monads
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W5
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            W5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../syntax_analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Syntax Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    W6
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            W6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Syntax Analysis Parser Combinator
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Syntax Analysis Parser Combinator
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-outcome" class="md-nav__link">
    <span class="md-ellipsis">
      Learning Outcome
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recap-top-down-parsing" class="md-nav__link">
    <span class="md-ellipsis">
      (Recap) Top-down parsing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(Recap) Top-down parsing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abstract-syntax-tree" class="md-nav__link">
    <span class="md-ellipsis">
      Abstract Syntax Tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#left-recursion-elimination" class="md-nav__link">
    <span class="md-ellipsis">
      Left Recursion Elimination
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-abstract-syntax-tree" class="md-nav__link">
    <span class="md-ellipsis">
      Additional Abstract Syntax Tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parser-combinator-with-backtracking" class="md-nav__link">
    <span class="md-ellipsis">
      Parser Combinator with Backtracking
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parser-combinator-without-backtracking-in-spirit-of-ll1" class="md-nav__link">
    <span class="md-ellipsis">
      Parser Combinator without backtracking (In spirit of LL(1))
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ir_pseudo_assembly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IR & Pseudo Assembly
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W8
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            W8
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantic_analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Semantic Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dynamic_semantics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dynamic Semantics
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W9
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            W9
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../static_semantics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Static Semantics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../static_semantics_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Static Semantics for Lambda Calculus
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W10
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            W10
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../name_analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Name Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sign_analysis_lattice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lattices & Sign Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W11
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            W11
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../liveness_analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Liveness Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../code_generation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code Generation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    W12
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            W12
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced_static_analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Information Flow Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-outcome" class="md-nav__link">
    <span class="md-ellipsis">
      Learning Outcome
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recap-top-down-parsing" class="md-nav__link">
    <span class="md-ellipsis">
      (Recap) Top-down parsing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(Recap) Top-down parsing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abstract-syntax-tree" class="md-nav__link">
    <span class="md-ellipsis">
      Abstract Syntax Tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#left-recursion-elimination" class="md-nav__link">
    <span class="md-ellipsis">
      Left Recursion Elimination
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-abstract-syntax-tree" class="md-nav__link">
    <span class="md-ellipsis">
      Additional Abstract Syntax Tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parser-combinator-with-backtracking" class="md-nav__link">
    <span class="md-ellipsis">
      Parser Combinator with Backtracking
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parser-combinator-without-backtracking-in-spirit-of-ll1" class="md-nav__link">
    <span class="md-ellipsis">
      Parser Combinator without backtracking (In spirit of LL(1))
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="50054-top-down-recursive-parsing-using-parser-combinators">50.054 - Top-down recursive parsing using Parser Combinators<a class="headerlink" href="#50054-top-down-recursive-parsing-using-parser-combinators" title="Permanent link">&para;</a></h1>
<h2 id="learning-outcome">Learning Outcome<a class="headerlink" href="#learning-outcome" title="Permanent link">&para;</a></h2>
<p>By the end of this class, you should be able to </p>
<ul>
<li>Implement a top-down recursive parser with backtracking</li>
<li>Implement a top-down recursive parser with on-demand backtracking </li>
</ul>
<h2 id="recap-top-down-parsing">(Recap) Top-down parsing<a class="headerlink" href="#recap-top-down-parsing" title="Permanent link">&para;</a></h2>
<p>In this secion we are going to focus on implementing Top-down parser.</p>
<p>Recall the grammar of a math expression. </p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>&lt;&lt;grammar 4&gt;&gt; 
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>E::= T + E
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>E::= T
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>T::= T * F 
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>T::= F
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>F::= i    
</span></code></pre></div></td></tr></table></div>
<h3 id="abstract-syntax-tree">Abstract Syntax Tree<a class="headerlink" href="#abstract-syntax-tree" title="Permanent link">&para;</a></h3>
<p>To implement top-down parsing, we first consider how to represent a parse tree in Haskell. 
It's natural to implement the parse trees in terms of some algebraic datatype. 
The Grammar 4 can be encoded with the following Haskell data type.</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span>
<span class="normal"><a href="#__codelineno-1-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kr">data</span><span class="w"> </span><span class="kt">Exp</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">TermExp</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">PlusExp</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span><span class="kt">Exp</span><span class="w"> </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Eq</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kr">data</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">FactorTerm</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">MultTerm</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Eq</span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kr">data</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span><span class="kt">Int</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Eq</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="left-recursion-elimination">Left Recursion Elimination<a class="headerlink" href="#left-recursion-elimination" title="Permanent link">&para;</a></h3>
<p>Recall Grammar 4 defined above contains some left recursion. </p>
<p>To eliminate the left recursion, we apply the same trick by rewriting left recursive grammar rules
$$
\begin{array}{rcl}
N &amp; ::= &amp; N\alpha_1 \
&amp; ... &amp; \
N &amp; ::= &amp; N\alpha_n \
N &amp; ::= &amp; \beta_1 \ 
&amp; ... &amp; \
N &amp; ::= &amp; \beta_m 
\end{array}
$$</p>
<p>into</p>
<div class="arithmatex">\[
\begin{array}{rcl}
N &amp; ::= &amp; \beta_1 N' \\
&amp; ... &amp; \\
N &amp; ::= &amp; \beta_m N' \\
N' &amp; ::= &amp; \alpha_1 N' \\ 
&amp; ... &amp; \\
N' &amp; ::= &amp; \alpha_n N' \\
N' &amp; ::= &amp; \epsilon
\end{array}
\]</div>
<p>Grammar 4 can be rewritten into</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>E  ::= T + E
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>E  ::= T
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>T  ::= FT&#39;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>T&#39; ::= *FT&#39;
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>T&#39; ::= epsilon
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>F  ::=i
</span></code></pre></div></td></tr></table></div>
<p>None of the production rules above contains common leading terminal symbols, hence there is no need to apply left-factorization.</p>
<p>Note that in the above Grammar 4 with left recursion eliminated, the only rules affected are thos with non-terminal <code>T</code>,</p>
<p>Hence we only need to added the following enum type</p>
<h3 id="additional-abstract-syntax-tree">Additional Abstract Syntax Tree<a class="headerlink" href="#additional-abstract-syntax-tree" title="Permanent link">&para;</a></h3>
<p>We could model it using Algebraic data type.
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kr">data</span><span class="w"> </span><span class="kt">TermLE</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">TermLE</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span><span class="kt">TermLEP</span><span class="w"> </span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kr">data</span><span class="w"> </span><span class="kt">TermLEP</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">MultTermLEP</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span><span class="kt">TermLEP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">Eps</span><span class="w"> </span>
</span></code></pre></div></td></tr></table></div></p>
<p>The main idea is when parsing a <code>Term</code>, instead of parsing directly, we parse a <code>TermLE</code> then convert it back to <code>Term</code>.</p>
<p><div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">[</span><span class="kt">IntTok</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kt">PlusTok</span><span class="p">,</span><span class="w"> </span><span class="kt">IntTok</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="kt">AsterixTok</span><span class="p">,</span><span class="w"> </span><span class="kt">IntTok</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
A parser method <code>parseExp</code> should generate</p>
<p><div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">PlusExp</span><span class="w"> </span><span class="p">(</span><span class="kt">FactorTerm</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="kt">TermExp</span><span class="w"> </span><span class="p">(</span><span class="kt">MultTerm</span><span class="w"> </span><span class="p">(</span><span class="kt">FactorTerm</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span>
</span></code></pre></div></td></tr></table></div>
where </p>
<ul>
<li>sub term <code>IntTok 1</code> was first parsed as <code>TermLE (Factor 1) Eps</code> then converted to <code>FactorTerm (Factor 1)</code>, and </li>
<li>sub term <code>IntTok 2, AsterixTok, IntTok 3</code> was first parsed as <code>TermLE (Factor 2) (MultTerm (Factor 3) Eps)</code> and converted to <code>MultTerm (Factor 2) (Factor 3)</code>.</li>
</ul>
<h3 id="parser-combinator-with-backtracking">Parser Combinator with Backtracking<a class="headerlink" href="#parser-combinator-with-backtracking" title="Permanent link">&para;</a></h3>
<p>We consider implementing the naive top-down recursive parser in Haskell. 
Let's start with the simplest cases. Let's say we would like to write a parsing function that takes a list of lexical tokens and "consumes" a token, then return the rest.</p>
<p><div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kr">data</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="n">a</span><span class="w"> </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nf">item</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">LToken</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="p">(</span><span class="kt">LToken</span><span class="p">,[</span><span class="kt">LToken</span><span class="p">])</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nf">item</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="s">&quot;item is called with an empty input&quot;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="nf">item</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="kt">:</span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
We define a variant of the <code>Maybe</code> datatype, <code>Result</code> which is either a failure with an error message, or an "Ok" result. The <code>item</code> function is what we would like to implement. It returns the extracted leading token with the rest of input if the input is non-empty, and signals a failure otherwise. </p>
<p>Apply the same idea we could define a conditional parsing function.</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nf">sat</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">LToken</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">LToken</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Bool</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="p">(</span><span class="kt">LToken</span><span class="p">,[</span><span class="kt">LToken</span><span class="p">])</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nf">sat</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="s">&quot;sat is called with an empty input&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nf">sat</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="kt">:</span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">t</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="kr">then</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="kr">else</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="s">&quot;sat is called with an input that does not satisfy the input predicate.&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>We may want to combine these basic parsing functions to form a larger parsing task, e.g.</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span>
<span class="normal"><a href="#__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nf">aBitMoreComplexParser</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">LToken</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="p">(</span><span class="kt">LToken</span><span class="p">,[</span><span class="kt">LToken</span><span class="p">])</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nf">aBitMoreComplexParser</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">toks2</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sat</span><span class="w"> </span><span class="n">toks2</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">t</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="kt">AsterixTok</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">True</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="kr">_</span><span class="w">          </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">False</span><span class="p">})</span><span class="w"> </span><span class="s">&quot;Expecting an asterix.&quot;</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>In the above, we define a parsing task which skips the first token and searches for the following asterix. We could imagine that to build a practical parser, we would need many of the basic parsing functions like <code>sat</code> and <code>item</code>, and combine them.</p>
<p>What we can observe from the above is that there are some similarity between <code>sat</code> and <code>item</code>, i.e. they both take in a list of tokens and returns the remaining tokens. If we view the lists of tokens as states, we could think of using the State Monad. We would also need this top-down parser to be able to backtrack in case of parsing failures. Recall the <code>MonadError</code> type class</p>
<p><div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kr">class</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">MonadError</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="n">throwError</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"> </span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="n">catchError</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span>
</span></code></pre></div></td></tr></table></div>
We define the <code>Parser</code> data type as follows, similar to the <code>State</code> case data type in the State Monad, except that we replace the <code>state</code> by the (parametric) parser environment type <code>env</code> </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span>
<span class="normal"><a href="#__codelineno-10-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kr">type</span><span class="w"> </span><span class="kt">Error</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kr">data</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="kt">String</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Eq</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="kr">newtype</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="kt">Parser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p><code>newtype</code> is like a special <code>data</code> type definition where there is no alternative.</p>
</blockquote>
<p>Next we provide the required type class instances to make <code>Parser env</code> into a <code>MonadError</code> instance. </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">Functor</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="n">fmap</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">Applicative</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="n">pure</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">))</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">eab</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">eab</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env1</span><span class="w">  </span><span class="kr">of</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">)</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="w">   </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">MonadError</span><span class="w"> </span><span class="kt">Error</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">    </span><span class="n">throwError</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w">  </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">    </span><span class="n">catchError</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea2</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">ea2</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w">  </span><span class="kt">Ok</span><span class="w"> </span><span class="n">v</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">        </span><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>With the Monad instance in-place, let's consider the "requirements" of the parser environment type <code>env</code>. We use the following type class to constraint any implementation of the parser environment must fulfill these requirements. </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span>
<span class="normal"><a href="#__codelineno-12-7">7</a></span>
<span class="normal"><a href="#__codelineno-12-8">8</a></span>
<span class="normal"><a href="#__codelineno-12-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kr">class</span><span class="w"> </span><span class="kt">ParserEnv</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">tok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">tok</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="kr">where</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">        </span><span class="n">getTokens</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">tok</span><span class="p">]</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">        </span><span class="n">getLine</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">        </span><span class="n">getCol</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">        </span><span class="n">setTokens</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="n">tok</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">        </span><span class="n">setLine</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">        </span><span class="n">setCol</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">        </span><span class="n">isNextTokNewLine</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Bool</span>
</span></code></pre></div></td></tr></table></div>
<p>Now we can re-define the <code>item</code> and <code>sat</code> function by making use of the monad (error) abstraction. </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">-- | The `item` combinator unconditionally parse the leading token. </span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="nf">item</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">ParserEnv</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">tok</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">tok</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="nf">item</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">getTokens</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">        </span><span class="n">ln</span><span class="w">   </span><span class="ow">=</span><span class="w"> </span><span class="n">getLine</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">        </span><span class="n">col</span><span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="n">getCol</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="s">&quot;item is called with an empty token stream.&quot;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">cs</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">isNextTokNewLine</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setLine</span><span class="w"> </span><span class="p">(</span><span class="n">ln</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">                </span><span class="n">env2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setCol</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">env1</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">                </span><span class="n">env3</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setTokens</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="n">env2</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">            </span><span class="kr">in</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">env3</span><span class="p">)</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setCol</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">                </span><span class="n">env2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setTokens</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="n">env1</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">            </span><span class="kr">in</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">)</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="c1">-- | The `sat` combinator consume the leading token if it satifies the predicate `p`.</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="nf">sat</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">ParserEnv</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">tok</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">tok</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Bool</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Error</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">tok</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="nf">sat</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">dbgMsg</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">getTokens</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="w">        </span><span class="n">ln</span><span class="w">   </span><span class="ow">=</span><span class="w"> </span><span class="n">getLine</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">        </span><span class="n">col</span><span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="n">getCol</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;sat is called with an empty token stream at line &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;, col &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;. &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">dbgMsg</span><span class="p">)</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="kt">:</span><span class="n">cs</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isNextTokNewLine</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setLine</span><span class="w"> </span><span class="p">(</span><span class="n">ln</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="w">                </span><span class="n">env2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setCol</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">env1</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a><span class="w">                </span><span class="n">env3</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setTokens</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="n">env2</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">            </span><span class="kr">in</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">env3</span><span class="p">)</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="kt">:</span><span class="n">cs</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a><span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setCol</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">                </span><span class="n">env2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">setTokens</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="n">env1</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">            </span><span class="kr">in</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">)</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="kt">:</span><span class="n">cs</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;sat is called with an unsatisfied predicate at line &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;, col &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;. &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">dbgMsg</span><span class="p">)</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="w">    </span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The <code>| condExp</code> defines a pattern guard in Haskell. For instance, in the <code>item</code> function above, the pattern case <code>(c : cs) | isNextTokNewLine env</code> is triggered 
when the incoming tokens <code>toks</code> are of shape <code>c:cs</code> and the <code>isNextTokenNewLine env</code> is <code>True</code>. Compared to the naive version of <code>item</code> defined earlier, this version abstracts away the details of the tokens retrieval and update. It also handles the book-keeping of the current token position in the source file. Like-wise <code>sat</code> function is updated to support the same features. </p>
<p>More importantly, we could define more generic and useful combinators</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nf">choice</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nf">choice</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">catchError</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">e</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">q</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The <code>choice</code> combinator takes two parsers <code>p</code> and <code>q</code>. It tries to run <code>p</code>. In case <code>p</code> fails, it backtracks (by restoring the original state) and runs <code>q</code>. </p>
<p>Now we can make use of <code>choice</code> to define an <code>optional</code> combinator
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nf">optional</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="p">(</span><span class="kt">Either</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nf">optional</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="ow">=</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Right</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">pa</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">        </span><span class="n">p2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kt">Left</span><span class="w"> </span><span class="nb">()</span><span class="p">)</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="n">choice</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">p2</span>
</span></code></pre></div></td></tr></table></div></p>
<p><code>optional</code> takes a parser <code>pa</code> and tries to execute it with the current input. If it fails, it restores the original state and returns <code>()</code>.</p>
<p>Let's try to write a parser for the simple arithmetic expression </p>
<p>Recall the nice property of a top-down parser is that the parser is correspondent to the top-down traversal of the production rules.</p>
<p>We provide the concrete definition of the parser environment data type as follows,</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kr">data</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">toks</span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">LToken</span><span class="p">]}</span><span class="w"> </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Eq</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">ParserEnv</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">LToken</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="n">getCol</span><span class="w"> </span><span class="n">penv</span><span class="w">           </span><span class="ow">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c1">-- ^ not in used. </span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="n">getLine</span><span class="w"> </span><span class="n">penv</span><span class="w">          </span><span class="ow">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c1">-- ^ not in used. </span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="n">setTokens</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="n">penv</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="n">penv</span><span class="p">{</span><span class="n">toks</span><span class="ow">=</span><span class="w"> </span><span class="n">ts</span><span class="p">}</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="n">setLine</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">penv</span><span class="w">        </span><span class="ow">=</span><span class="w"> </span><span class="n">penv</span><span class="w"> </span><span class="c1">-- ^ not in used.</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="n">setCol</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">penv</span><span class="w">         </span><span class="ow">=</span><span class="w"> </span><span class="n">penv</span><span class="w"> </span><span class="c1">-- ^ not in used. </span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">    </span><span class="n">isNextTokNewLine</span><span class="w"> </span><span class="n">penv</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">False</span><span class="w"> </span><span class="c1">-- ^ not in used. </span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="n">getTokens</span><span class="w">             </span><span class="ow">=</span><span class="w"> </span><span class="n">toks</span><span class="w">   </span>
</span></code></pre></div></td></tr></table></div>
<p>Recall the grammar 4 of Math expression with left recursion.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>E::= T + E
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>E::= T
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>T::= T * F 
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>T::= F
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a>F::= i    
</span></code></pre></div></td></tr></table></div>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nf">parseExp</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">Exp</span><span class="w"> </span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nf">parseExp</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">choice</span><span class="w"> </span><span class="n">parsePlusExp</span><span class="w"> </span><span class="n">parseTermExp</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="nf">parsePlusExp</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">Exp</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="nf">parsePlusExp</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="n">t</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseTerm</span><span class="w"> </span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="n">plus</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parsePlusTok</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="n">e</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseExp</span><span class="w"> </span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kt">PlusExp</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="nf">parseTermExp</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">Exp</span><span class="w"> </span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="nf">parseTermExp</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseTerm</span><span class="w"> </span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kt">TermExp</span><span class="w"> </span><span class="n">t</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Up to this point we are ok as production rules with <code>E</code> on the LHS are not left recursive.
It gets tricky when paarsing <code>T</code> which contains left recursion. Recall the modified grammar of 
<code>T</code> having left-recursion eliminated.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>T  ::= FT&#39;  
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>T&#39; ::= *FT&#39;
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a>T&#39; ::= epsilon
</span></code></pre></div></td></tr></table></div>
<p>In terms of Haskell data type, we refer to them as <code>TermLE</code> and <code>TermLEP</code>.
Hence the parser <code>parserTerm</code> has to be defined in terms of <code>parseTermLE</code>, then 
convert the result of <code>TermLE</code> back to <code>Term</code></p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="nf">parseTerm</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nf">parseTerm</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="n">tle</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseTermLE</span><span class="w"> </span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">fromTermLE</span><span class="w"> </span><span class="n">tle</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div></td></tr></table></div>
<p>Where <code>parseTermLE</code> can be implemented using parsec, </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span>
<span class="normal"><a href="#__codelineno-21-42">42</a></span>
<span class="normal"><a href="#__codelineno-21-43">43</a></span>
<span class="normal"><a href="#__codelineno-21-44">44</a></span>
<span class="normal"><a href="#__codelineno-21-45">45</a></span>
<span class="normal"><a href="#__codelineno-21-46">46</a></span>
<span class="normal"><a href="#__codelineno-21-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="nf">parseTermLE</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">TermLE</span><span class="w"> </span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nf">parseTermLE</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="n">f</span><span class="w">  </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseFactor</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="n">tp</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseTermP</span><span class="w"> </span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kt">TermLE</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">tp</span><span class="p">)</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="nf">parseTermP</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">TermLEP</span><span class="w"> </span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="nf">parseTermP</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">    </span><span class="n">omt</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="n">parseMultTermP</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">    </span><span class="kr">case</span><span class="w"> </span><span class="n">omt</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">        </span><span class="kt">Left</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="kt">Eps</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="w">        </span><span class="kt">Right</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="n">t</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13"></a>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14"></a>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="nf">parseMultTermP</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">TermLEP</span><span class="w"> </span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="nf">parseMultTermP</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="w">    </span><span class="n">asterix</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseAsterixTok</span><span class="w"> </span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="w">    </span><span class="n">f</span><span class="w">       </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseFactor</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="w">    </span><span class="n">tp</span><span class="w">      </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseTermP</span><span class="w"> </span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20"></a><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kt">MultTermLEP</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">tp</span><span class="p">)</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21"></a>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22"></a><span class="nf">parseFactor</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">Factor</span><span class="w"> </span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23"></a><span class="nf">parseFactor</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24"></a><span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">parseIntTok</span><span class="w"> </span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25"></a><span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">justOrFail</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">\</span><span class="w"> </span><span class="n">itok</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">itok</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">IntTok</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Nothing</span><span class="w"> </span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28"></a><span class="w">        </span><span class="p">})</span><span class="w"> </span><span class="s">&quot;parseFactor fail: expect to parse an integer token but it is not an integer.&quot;</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29"></a><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="n">f</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30"></a>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31"></a>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32"></a><span class="nf">parsePlusTok</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">LToken</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33"></a><span class="nf">parsePlusTok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sat</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">PlusTok</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">True</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="kr">_</span><span class="w">       </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">False</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36"></a><span class="w">    </span><span class="p">})</span><span class="w"> </span><span class="s">&quot;parsePlusTok failed, expecting a plus token.&quot;</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37"></a>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38"></a><span class="nf">parseAsterixTok</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">LToken</span><span class="w"> </span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39"></a><span class="nf">parseAsterixTok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sat</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40"></a><span class="w">    </span><span class="kt">AsterixTok</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">True</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41"></a><span class="w">    </span><span class="kr">_</span><span class="w">          </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">False</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s">&quot;parseAsterixTok failed, expecting an asterix token.&quot;</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42"></a>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43"></a>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44"></a><span class="nf">parseIntTok</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">LToken</span><span class="w"> </span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45"></a><span class="nf">parseIntTok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sat</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46"></a><span class="w">    </span><span class="kt">IntTok</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">True</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47"></a><span class="w">    </span><span class="kr">_</span><span class="w">        </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">False</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s">&quot;parseIntTok failed, expecting an integer token.&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>Finally the <code>TermLE</code> to <code>Term</code> conversion is an inversed in order traversal, as the parse tree of <code>TermLE</code></p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span>
<span class="normal"><a href="#__codelineno-22-6">6</a></span>
<span class="normal"><a href="#__codelineno-22-7">7</a></span>
<span class="normal"><a href="#__codelineno-22-8">8</a></span>
<span class="normal"><a href="#__codelineno-22-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>    T
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a>   / \
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a>  f   T&#39;
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a>     /|\
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a>    * f T&#39;
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a>       /|\
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a>      * f T&#39;
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a>          |
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a>         eps
</span></code></pre></div></td></tr></table></div>
<p>and the parse tree of <code>Term</code> is</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span>
<span class="normal"><a href="#__codelineno-23-3">3</a></span>
<span class="normal"><a href="#__codelineno-23-4">4</a></span>
<span class="normal"><a href="#__codelineno-23-5">5</a></span>
<span class="normal"><a href="#__codelineno-23-6">6</a></span>
<span class="normal"><a href="#__codelineno-23-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a>        T
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a>       /|\
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a>      T * f
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a>     /| \
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a>    T * f 
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a>    |
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a>    f
</span></code></pre></div></td></tr></table></div>
<p>The implementation can be found as follows,</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span>
<span class="normal"><a href="#__codelineno-24-6">6</a></span>
<span class="normal"><a href="#__codelineno-24-7">7</a></span>
<span class="normal"><a href="#__codelineno-24-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="nf">fromTermLE</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">TermLE</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nf">fromTermLE</span><span class="w"> </span><span class="p">(</span><span class="kt">TermLE</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">tep</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">fromTermLEP</span><span class="w"> </span><span class="p">(</span><span class="kt">FactorTerm</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="n">tep</span><span class="w"> </span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="nf">fromTermLEP</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">TermLEP</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Term</span><span class="w"> </span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="nf">fromTermLEP</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="kt">Eps</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="nf">fromTermLEP</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="p">(</span><span class="kt">MultTermLEP</span><span class="w"> </span><span class="n">f2</span><span class="w"> </span><span class="n">tp2</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">MultTerm</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">f2</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="n">fromTermLEP</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="n">tp2</span>
</span></code></pre></div></td></tr></table></div>
<p>And here is some test cases</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="nf">it</span><span class="w"> </span><span class="s">&quot;test parse 1+2*3&quot;</span><span class="w"> </span><span class="o">$</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">toks</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kt">IntTok</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kt">PlusTok</span><span class="p">,</span><span class="w"> </span><span class="kt">IntTok</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="kt">AsterixTok</span><span class="p">,</span><span class="w"> </span><span class="kt">IntTok</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">parseExp</span><span class="w"> </span><span class="p">(</span><span class="kt">PEnv</span><span class="w"> </span><span class="n">toks</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">        </span><span class="n">expected</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="kt">PlusExp</span><span class="w"> </span><span class="p">(</span><span class="kt">FactorTerm</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="kt">TermExp</span><span class="w"> </span><span class="p">(</span><span class="kt">MultTerm</span><span class="w"> </span><span class="p">(</span><span class="kt">FactorTerm</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="kt">Factor</span><span class="w"> </span><span class="mi">3</span><span class="p">))),</span><span class="w"> </span><span class="kt">PEnv</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">`</span><span class="n">shouldBe</span><span class="p">`</span><span class="w"> </span><span class="n">expected</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="parser-combinator-without-backtracking-in-spirit-of-ll1">Parser Combinator without backtracking (In spirit of LL(1))<a class="headerlink" href="#parser-combinator-without-backtracking-in-spirit-of-ll1" title="Permanent link">&para;</a></h2>
<p>Let's extend our parser combinator to support <code>LL(1)</code> parsing without backtracking.</p>
<p>We introduce the following algebraic datatype to label an (intermediate) parsing result 
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kr">data</span><span class="w"> </span><span class="kt">Progress</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="kr">deriving</span><span class="w"> </span><span class="kt">Show</span>
</span></code></pre></div></td></tr></table></div></p>
<p>The partial is is <code>Consumed</code> when there has been input tokens consumed, otherwise, <code>Empty</code>.</p>
<p>We adjust the definition of the <code>Parser</code> case class as follows</p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="kr">newtype</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">    </span><span class="kt">Parser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Progress</span><span class="w"> </span><span class="p">(</span><span class="kt">Result</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">))</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Next we update the type class instances accordingly. </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span>
<span class="normal"><a href="#__codelineno-28-32">32</a></span>
<span class="normal"><a href="#__codelineno-28-33">33</a></span>
<span class="normal"><a href="#__codelineno-28-34">34</a></span>
<span class="normal"><a href="#__codelineno-28-35">35</a></span>
<span class="normal"><a href="#__codelineno-28-36">36</a></span>
<span class="normal"><a href="#__codelineno-28-37">37</a></span>
<span class="normal"><a href="#__codelineno-28-38">38</a></span>
<span class="normal"><a href="#__codelineno-28-39">39</a></span>
<span class="normal"><a href="#__codelineno-28-40">40</a></span>
<span class="normal"><a href="#__codelineno-28-41">41</a></span>
<span class="normal"><a href="#__codelineno-28-42">42</a></span>
<span class="normal"><a href="#__codelineno-28-43">43</a></span>
<span class="normal"><a href="#__codelineno-28-44">44</a></span>
<span class="normal"><a href="#__codelineno-28-45">45</a></span>
<span class="normal"><a href="#__codelineno-28-46">46</a></span>
<span class="normal"><a href="#__codelineno-28-47">47</a></span>
<span class="normal"><a href="#__codelineno-28-48">48</a></span>
<span class="normal"><a href="#__codelineno-28-49">49</a></span>
<span class="normal"><a href="#__codelineno-28-50">50</a></span>
<span class="normal"><a href="#__codelineno-28-51">51</a></span>
<span class="normal"><a href="#__codelineno-28-52">52</a></span>
<span class="normal"><a href="#__codelineno-28-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">Functor</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="n">fmap</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">))</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">))</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">Applicative</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">    </span><span class="n">pure</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">)))</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="w">    </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">eab</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">eab</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">cont</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="w">                </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="w">                </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19"></a><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">)</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21"></a><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">)</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="w">            </span><span class="kr">in</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">cont</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env1</span><span class="w">  </span><span class="kr">of</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28"></a><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">))</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30"></a><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">))</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env2</span><span class="p">))</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33"></a>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34"></a>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36"></a><span class="w">    </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37"></a><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38"></a><span class="w">                </span><span class="kr">let</span><span class="w"> </span><span class="n">cont</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39"></a><span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40"></a><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span><span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41"></a><span class="w">                        </span><span class="p">{</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42"></a><span class="w">                            </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">x</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43"></a><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="n">x</span><span class="w">    </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">x</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47"></a><span class="w">                </span><span class="kr">in</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">cont</span>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48"></a><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-49"><a id="__codelineno-28-49" name="__codelineno-28-49"></a><span class="w">                </span><span class="p">{</span><span class="w"> </span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="w">   </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span>
</span><span id="__span-28-50"><a id="__codelineno-28-50" name="__codelineno-28-50"></a><span class="w">                </span><span class="p">;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">env1</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-28-51"><a id="__codelineno-28-51" name="__codelineno-28-51"></a><span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="n">env1</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-28-52"><a id="__codelineno-28-52" name="__codelineno-28-52"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-28-53"><a id="__codelineno-28-53" name="__codelineno-28-53"></a><span class="w">            </span><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Let's look at the <code>&gt;&gt;=</code>, the Monadic bind. It takes the first parser (<code>Parser ea</code>) and pattern-matches it against <code>Parser(p)</code>. In the output parser, we first apply <code>ea</code> to the input environment <code>env</code>. </p>
<ul>
<li>If the result's progress is <code>Empty v</code>, we check whether <code>v</code> is an error or <code>Ok</code>. When it is an error, it will be propogated, otherwise, we apply <code>f</code> to the output of <code>a</code>. That will give us the second parser to continue with, <code>Parser eb</code>. We then apply <code>eb</code> to <code>env1</code> which should be the same as <code>env</code> since nothing has been consumed. </li>
<li>If the result's progress is <code>Consumed v</code>, some part of input tokens in the environment <code>env</code> has been parsed. The parser's behaviour here should be similar to the previous case, except that <code>eb env1</code> progress result will always be updated as <code>Consumed</code> regardless whether <code>eb</code> has consumed anything. Thanks Haskell lazy evaluation, the result held by variable <code>cont</code> is delayed until it is actually needed. Such an optimization allows us to return the progress information <code>Consumed</code> without actually executing <code>eb  env1</code> when its result is not needed.</li>
</ul>
<p>Similar observation applies to <code>&lt;*&gt;</code> function in the applicative instance.</p>
<p>The defintion of the <code>MonadError</code> type class instance is adjusted to recognize 
the <code>Consumed</code> and <code>Empty</code> data. </p>
<div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kr">instance</span><span class="w"> </span><span class="kt">MonadError</span><span class="w"> </span><span class="kt">Error</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="n">throwError</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">))</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="n">catchError</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="c1">-- we don&#39;t backtrack when something is already consumed.</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea2</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">ea2</span><span class="w"> </span><span class="n">env</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="c1">-- LL(1) parser will also attempt to look at f if fa does not consume anything </span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">            </span><span class="kr">case</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="s">&quot;faked error&quot;</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">                </span><span class="p">{</span><span class="w">  </span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea2</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea2</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="c1">-- if handle also fails, we report the same error.</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">consumed</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">consumed</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="w">        </span><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>The highlight is in the <code>catchError</code> function,  we do not backtrack when the 
the first parser <code>(Parser ea)</code> has consumed some input. 
The error recovery method <code>handle</code> is applied only when the progress of the parsing so far is <code>Empty</code>. In other words, given a choice of two parsers <code>choice p1 p2</code>, it will not backtrack to <code>p2</code> if <code>p1</code> has consumed some token. This is in-sync with predictive parsing.</p>
<p>All other combinators such as <code>choice</code>, <code>item</code>, <code>sat</code>, <code>optional</code> can be adjusted in the same fashion. We refer to the cohort exercise template code <code>Parsec.hs</code> for details. </p>
<p>We know that not all languages are in <code>LL(1)</code>.  It is undecidable to find out which <code>k</code> of <code>LL(k)</code> that a language is in. Thus, the above parser might not be very useful since it only works if the given language is in <code>LL(1)</code>. </p>
<p>Thanks to the Monadic design, it is very easy to extend the parser to accept non <code>LL(1)</code> language by supporting backtracking on-demand. That is, the parser by default is not backtracking, however, it could if we want it to backtrack explicitly.</p>
<p><div class="language-hs highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span>
<span class="normal"><a href="#__codelineno-30-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1">-- | The `attempt` combinator explicitly tries a parser and backtracks if it fails.</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="nf">attempt</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="nf">attempt</span><span class="w"> </span><span class="p">(</span><span class="kt">Parser</span><span class="w"> </span><span class="n">ea</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">env</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="kr">of</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">Consumed</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Empty</span><span class="w"> </span><span class="p">(</span><span class="kt">Failed</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="c1">-- undo the consumed effect if it fails. </span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">other</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">    </span><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
The <code>attempt</code> combinator takes a parser <code>Parser ea</code> and runs it. If its result is <code>Consumed</code> but <code>Failed</code>, it will <em>reset</em> the progress as <code>Empty</code>.  </p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "navigation.expand", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>